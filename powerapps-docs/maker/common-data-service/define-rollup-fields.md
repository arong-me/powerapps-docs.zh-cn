---
title: 使用 PowerApps 定义汇总字段 | MicrosoftDocs
description: 了解如何定义汇总字段
ms.custom: ''
ms.date: 05/23/2018
ms.reviewer: ''
ms.service: crm-online
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
applies_to:
- Dynamics 365 (online)
- Dynamics 365 Version 9.x
- powerapps
author: Mattp123
ms.assetid: ff0504a1-01bd-4f9b-b884-7f84911d86c3
caps.latest.revision: 58
ms.author: matp
manager: kvivek
ms.openlocfilehash: c76162747ac2bda27c46895290e5943b7f46739f
ms.sourcegitcommit: aba996b1773ecdf62758e06b34eaf57bede29e08
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/08/2018
ms.locfileid: "39667764"
---
# <a name="define-rollup-fields-that-aggregate-values"></a>定义聚合值的汇总字段

汇总字段可帮助用户通过监视关键业务指标来获取有关数据的见解。 汇总字段包含对与指定记录相关的记录进行计算得到的聚合值。 这包括常规实体和活动实体，如电子邮件和约会。

在更复杂的情况下，可以通过记录的层次结构聚合数据。 作为管理员或定制员，可以使用 PowerApps 中的自定义工具定义汇总字段，而无需编写代码。  
  
<a name="BKMK_benefitsandcapabilities"></a> 
 
## <a name="rollup-fields-benefits-and-capabilities"></a>汇总字段优势和功能  

汇总字段的优势和功能包括以下这些：  
  
- 可视编辑十分方便。 可以使用字段编辑器创建汇总字段，就如同创建常规字段时进行操作一样。  
- 多种多样的聚合函数。 可以使用以下函数聚合数据：`SUM`、`COUNT`、`MIN`、`MAX` 和 `AVG`。  
- 针对聚合的完整筛选器支持。 可以为源实体或相关实体设置各种筛选器，同时设置多个条件。  
- 与用户界面的无缝集成。 可以在窗体、视图、图表和报表中包含汇总字段。  
- 汇总字段是解决方案组件。 可以将汇总字段作为组件轻松地在环境之间进行传输，并在解决方案中分发它们。  
- 汇总字段和计算字段可相互补充。 可以使用汇总字段作为计算字段的一部分，反之亦然。  
- 可以配置汇总字段以使用自定义控件。  
  
 汇总字段的一些示例包括：  
  
- 一个帐户开启的商机的总预计收入  
- 一个层次结构中所有帐户间开启的商机的总预计收入  
- 一个商机（包括子商机）的总预计收入  
- 一个市场活动生成的合格潜在客户的总预计值  
- 一个层次结构中所有帐户间的高优先级已打开案例数  
- 一个帐户的所有高优先级已打开案例的最早创建时间  
  
每个汇总字段都会创建两个具有 &lt;fieldname&gt;`_date` 和 &lt;fieldname&gt;`_state` 后缀模式的附属字段。 `_date` 字段包含日期/时间数据，`_state` 字段包含整数数据。 `_state` 字段具有以下值：  
  
|值|状况|描述|  
|-|-|-|  
|0|NotCalculated|字段值尚未进行计算。|  
|1|已计算|字段值已按照 _date 字段中的上次更新时间进行计算。|  
|2|OverflowError|字段值计算导致溢出错误。|  
|3|OtherError|字段值计算失败，因为出现内部错误。 计算作业的后续运行可能会修复该错误。|  
|4|RetryLimitExceeded|字段值计算失败，因为大量并发和锁定冲突导致超出了用于计算值的最大重试尝试次数。|  
|5|HierarchicalRecursionLimitReached|字段值计算失败，因为已达到计算的最大层次结构深度限制。|  
|6|LoopDetected|字段值计算失败，因为在记录的层次结构中检测到递归循环。|  
  
<a name="BKMK_calculations"></a>  
 
## <a name="rollup-calculations"></a>汇总计算  

汇总由在后台异步运行的计划系统作业进行计算。 必须是管理员才能查看和管理汇总作业。 

### <a name="view-rollup-jobs"></a>查看汇总作业

若要查看汇总作业，请执行以下操作：

1. 在查看 **Common Data Services 默认解决方案**时，编辑 URL（删除 `dynamics.com` 后的所有内容），然后刷新页面。
2. 在“设置”区域中，选择“系统” > “系统作业”。<br />![导航到系统作业](media/navigate-system-jobs.png)
1. 在视图选择器中，选择“定期系统作业”。
2. 若要快速查找相关作业，可以按系统作业类型进行筛选：“批量计算汇总字段”或“计算汇总字段”。
 
### <a name="mass-calculate-rollup-field"></a>批量计算汇总字段

“批量计算汇总字段”是对汇总字段创建的定期作业。 它在创建或更新了汇总字段之后运行一次。 作业会在包含此字段的所有现有记录中重新计算指定汇总字段值。 默认情况下，作业会在创建或更新了字段 12 小时之后运行。 作业完成之后，它会自动计划为在遥远的将来（大约 10 年后）运行。 如果修改了字段，则作业会进行重置，以便在更新 12 小时之后再次运行。 需要 12 小时延迟以确保“批量计算汇总字段”在环境的非工作时间内运行。 建议管理员在创建或修改汇总字段之后调整“批量计算汇总字段”作业的开始时间，以便它在非工作时间内运行。 例如，午夜会是运行作业的好时间，以确保高效处理汇总字段。  

### <a name="calculate-rollup-field"></a>计算汇总字段 

“计算汇总字段”是定期作业，为指定实体执行现有记录中所有汇总字段的增量计算。 每个实体只有一个“计算汇总字段”作业。 增量计算表示“计算汇总字段”作业会处理在上次“批量计算汇总字段”作业完成执行之后创建、更新或删除的记录。 默认最大重复周期设置是一小时。 作业会自动在创建实体上的第一个汇总字段时进行创建，并在删除最后一个汇总字段时进行删除。  

## <a name="online-recalculation-option"></a>联机重新计算选项
如果将鼠标悬停在窗体上的汇总字段上方，则可以看到上次汇总的时间，并且可以通过选择字段旁的“刷新”图标来刷新汇总值，如下所示：  

![帐户窗体上的汇总字段](media/rollup-field-on-account-form.png)
  

使用联机重新计算选项（对窗体的手动刷新）时应牢记几个注意事项：  
  
- 必须拥有实体的写入特权，并且拥有对其请求刷新的源记录的写入访问权限。 例如，如果通过帐户开启的商机计算预计收入，则不必拥有商机实体的写入特权，只需拥有客户实体的写入特权。  
- 此选项仅在联机模式下才可用。 脱机工作时无法使用它。  
- 汇总刷新过程中的最大记录数限制为 50,000 个记录。 对于分层汇总，这适用于层次结构中的相关记录。 如果超出限制，则会看到错误消息：无法联机执行计算，因为已达到 50,000 个相关记录的计算限制。 当系统作业自动重新计算汇总时，此限制不适用。  
- 对于源记录，最大层次结构深度限制为 10。 如果超出限制，则会看到错误消息：无法联机执行计算，因为已达到针对源记录的层次结构深度限制 10。 当系统作业自动重新计算汇总时，此限制不适用。  

## <a name="modify-rollup-job-recurrence"></a>修改汇总作业定期项

作为系统管理员，可以修改汇总作业定期模式、推迟、暂停或恢复汇总作业。 但是，无法取消或删除汇总作业。 

若要暂停、推迟、恢复或修改定期模式，必须查看系统作业。 详细信息：[查看汇总作业](#view-rollup-jobs) 

在导航栏上选择“操作”，然后选择所需操作。 

对于“批量计算汇总字段”作业，可用选项包括：“恢复”、“推迟”和“暂停”。 

对于“计算汇总字段”作业，可用选项包括：“修改定期项”、“恢复”、“推迟”和“暂停”。  
  
<a name="BKMK_businessscenarios"></a>  
 
## <a name="examples"></a>示例 

让我们看看几个汇总字段示例。 我们会从相关记录聚合记录的数据（使用以及不使用层次结构）。 我们还会通过 ActivityParty 实体，从相关活动以及与记录间接相关的活动聚合记录的数据。 在每个示例中，我们会使用字段编辑器定义汇总字段。 若要打开字段编辑器，请打开解决方案资源管理器，然后展开“组件” > “实体”。 选择所需实体并选择“字段”。 选择“新建”。 在编辑器中，提供字段的所需信息，包括“字段类型”和“数据类型”。 在“字段类型”中，在选择了数据类型之后选择“汇总”。 数据类型包括小数或整数、货币和日期/时间。 选择“字段类型”旁的“编辑”按钮。 这会进入汇总字段定义编辑器。 汇总字段定义由三个部分组成：“源实体”、“相关实体”和“聚合”。  
  
-   在“源实体”部分中，指定为其定义汇总字段的实体，以及是否通过层次结构进行聚合。 可以添加具有多个条件的筛选器来指定层次结构中要用于汇总的记录。  
  
-   在“相关实体”部分中，指定对其进行聚合的实体。 当选择通过源实体上的层次结构进行汇总时，此部分是可选的。 可以添加具有多个条件的筛选器来指定要在计算中使用的相关记录。 例如，可包括来自年收入大于 1000 美元的开启商机的收入。  
  
-   在“聚合”部分中，指定要计算的指标。 可以选择可用聚合函数，如 SUM、COUNT、MIN、MAX 或 AVG。  
  
### <a name="aggregate-data-for-a-record-from-related-records"></a>从相关记录聚合记录的数据  

在此示例中，不使用层次结构。 从相关开启商机，为帐户计算总预计收入。  

![为帐户聚合预计收入](media/rollup-field-no-hierarchy.png)
  
### <a name="aggregate-data-for-a-record-from-the-child-records-over-the-hierarchy"></a>通过层次结构从子记录聚合记录的数据 
 
在此示例中，我们通过层次结构计算商机（包括子商机）的总预计收入。  
  
![聚合预计收入，商机层次结构](media/rollup-field-hierarchy-self.png)
  
### <a name="aggregate-data-for-a-record-from-the-related-records-over-the-hierarchy"></a>通过层次结构从相关记录聚合记录的数据

在此示例中，我们通过层次结构计算所有帐户间开启的商机的总预计收入。  
  
![通过帐户层次结构聚合预计收入](media/rollup-field-hierarchy.png)  
  
### <a name="aggregate-data-for-a-record-from-all-related-activities"></a>从所有相关活动聚合记录的数据
  
在此示例中，我们计算与帐户相关的所有活动消耗和计费的总时间。 这可能包括在电话、约会或自定义活动方面消耗的时间。  
  
在早期版本中，可以为单个活动（如电话联络、传真或约会）定义汇总字段。 但是，若要实现以下所示的示例的结果，必须使用计算字段汇总数据。 现在可以通过为活动实体定义一个汇总字段，在一个步骤中完成所有工作。  
  
![汇总帐户的所有活动](media/rollup-enhancements-activities.png)  
  
### <a name="aggregate-data-for-a-record-from-all-related-activities-and-activities-indirectly-related-via-the-activity-party-entity"></a>通过活动方实体，从所有相关活动以及间接相关活动聚合记录的数据  

在此示例中，我们对发送到帐户的电子邮件总数进行计数，其中帐户会在电子邮件的“收件人”行或“抄送收件人”行上列出。 实现方式是在汇总字段定义中针对“活动方”实体，在“筛选器”中指定“参与类型”。 如果不使用筛选，则会在计算中使用活动的所有可用参与类型。 
 
有关可用于特定活动的“活动方”实体和参与类型的详细信息，请参阅 [ActivityParty 实体](/dynamics365/customer-engagement/developer/activityparty-entity)。

  
![汇总相关活动和活动方](media/rollup-enhancements-indirect-activities.png)  
  
### <a name="aggregate-data-for-a-record-from-related-records-using-the-avg-operator"></a>使用 AVG 运算符从相关记录聚合记录的数据

在此示例中，我们从与帐户相关的所有商机计算平均预计收入。  
  
![Dynamics 365 中的平均预计收入](media/rollup-enhancements-average.PNG)  
  
下面的示例演示如何通过帐户的层次结构，从相关商机计算平均预计收入。 平均预计收入可以在层次结构中的每个级别上进行查看。  
  
![Dynamics 365 中的平均预计收入](media/cust-rollup-enhancements-avg-over-hierarchy.png)  
  
<a name="BKMK_considerations"></a> 

## <a name="rollup-field-considerations"></a>汇总字段注意事项 

使用汇总字段时，应注意某些条件和限制：  
  
- 可以为组织定义最多 100 个汇总字段，对每个实体定义多达 10 个汇总字段。  
- 汇总字段更新无法触发工作流。  
- 工作流等待条件无法使用汇总字段。  
- 不支持对汇总字段的汇总。  
- 汇总无法引用使用其他计算字段的计算字段，即使其他计算字段的所有字段都在当前实体上。  
- 汇总只能对源实体或相关实体、简单字段或非复杂计算字段应用筛选器。  
- 只能对具有 1:N 关系的相关实体进行汇总。 无法对 N:N 关系进行汇总。  
- 无法对活动实体或活动方实体的 1:N 关系进行汇总。  
- 业务规则、工作流或计算字段始终使用汇总字段的最后一个计算值。  
- 汇总字段在系统用户上下文下进行聚合。 所有用户都能够看到相同的汇总字段值。 可以通过限制可以访问汇总字段的人员，来使用字段级别安全性 (FLS) 控制汇总字段可见性。 详细信息：[用于控制访问的字段级别安全性](/dynamics365/customer-engagement/admin/field-level-security)。 

### <a name="precision-rounding"></a>精度舍入
 
如果聚合字段的精度大于汇总字段的精度，则在执行聚合之前，聚合字段精度会向下舍入为汇总字段的精度。 为了说明此行为，让我们看一个特定示例。 假设帐户实体上的汇总字段（用于计算相关商机的总预计收入）的精度是两个小数位。 商机 实体上的预计收入字段是精度为四个小数位的聚合字段。 在我们的示例中，帐户具有两个相关商机。 预计收入的聚合总数计算方式如下所示：  
  
1. 针对 第一个商机的预计收入：1000.0041 美元  
1. 针对 第二个商机的预计收入：2000.0044 美元  
1. 预计收入的聚合 总数：1000.00 美元 + 2000.00 美元 = 3000.00 美元

如你所见，在执行聚合之前，聚合字段上的精度会向下舍入为两个小数位。  
  
### <a name="different-behavior-from-associated-grids"></a>与关联网格不同的行为
 
某些实体窗体（如帐户或联系人）现成包含关联网格。 例如，帐户窗体包括联系人、案例、商机和其他网格。 帐户窗体网格中显示的某些记录与帐户记录直接相关；其他记录通过与其他记录的关系间接相关。 相比之下，汇总字段聚合仅使用在汇总字段定义中显式定义的直接关系。 不考虑任何其他关系。 为了说明行为差异，我们来看看下面的示例。  
  
1. 帐户 A1 有一个主要联系人 P1。 案例 C1 与帐户 A1 关联（C1.Customer 字段 = A1），案例 C2 与联系人 P1 关联（C2.Customer 字段 = P1）。  
1. A1 记录的“帐户”窗体上的“案例”网格显示两个案例 C1 和 C2。  
1. 帐户实体上的汇总字段（名为“案例总数”）用于对与帐户关联的案例进行计数。  
1. 在帐户汇总字段定义中，我们指定与帐户之间具有客户关系的案例。 聚合之后，案例总数等于 1（案例 C1）。 案例 C2 未包括在总数中，因为它与联系人（而不是帐户）直接相关，无法在帐户汇总字段定义中显式定义。 因此，汇总运算返回的案例总数与“案例”网格中显示的案例数不匹配。  
  
### <a name="see-also"></a>另请参阅  

[创建并编辑字段](create-edit-fields.md)<br />
[定义计算字段](define-calculated-fields.md)<br />
[“日期和时间”字段的行为和格式](behavior-format-date-time-field.md)<br />
[定义和查询按层次结构相关的数据](define-query-hierarchical-data.md)<br />
[视频：汇总和计算字段](http://www.youtube.com/watch?v=RoahCH1p3T8&list=PLC3591A8FE4ADBE07&index=8)<br />
[视频：使用 Power BI](http://www.youtube.com/watch?v=PkQe4BFlBS8&list=PLC3591A8FE4ADBE07&index=3)
